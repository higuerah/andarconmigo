<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Para ti</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; background: #000; }

    #starter {
      position: fixed; inset: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #fff;
    }

    #startBtn {
      padding: 12px 18px;
      background: #ff3366;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
    }

    #videoPlane {
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
    }
  </style>
</head>

<body>

<div id="starter">
  <button id="startBtn">Hay tanto que quiero contarte...</button>
  <p style="margin-top:10px; opacity:.7;">Apunta al collar bebé ❤️</p>
</div>

<a-scene embedded vr-mode-ui="enabled:false" arjs="sourceType: webcam; debugUIEnabled: false;">

  <a-assets>
    <video id="vid" src="video.mp4" preload="auto" loop playsinline webkit-playsinline crossorigin="anonymous"></video>
  </a-assets>

  <!-- MARCADOR -->
  <a-marker id="marker" type="pattern" url="pattern-marker.patt"
            smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">

    <a-entity id="container" rotation="-90 0 0">

      <!-- BORDE DIFUMINADO (Glow) -->
      <a-plane
        id="glow"
        width="1.25"
        height="0.70"
        position="0 0 -0.01"
        material="color: #ffffff; opacity: 0.25; shader: flat; transparent: true;">
      </a-plane>

      <!-- VIDEO ORIGINAL -->
      <a-video
        id="videoPlane"
        src="#vid"
        width="1"
        height="0.56"
        position="0 0 0"
        material="shader: flat;">
      </a-video>

    </a-entity>
  </a-marker>

  <a-entity id="camera" camera></a-entity>
</a-scene>

<script>
  const startBtn = document.getElementById("startBtn");
  const starter = document.getElementById("starter");
  const video = document.getElementById("vid");
  const marker = document.getElementById("marker");
  const videoPlane = document.getElementById("videoPlane");
  const container = document.getElementById("container");
  const camera = document.getElementById("camera");

  // Iniciar
  startBtn.addEventListener("click", async () => {
    starter.style.display = "none";

    try {
      await video.play();
      video.pause();
    } catch (e) {}
  });

  marker.addEventListener("markerFound", () => {
    video.currentTime = 0;
    video.play();
    videoPlane.setAttribute("opacity", 1);
  });

  marker.addEventListener("markerLost", () => {
    video.pause();
    videoPlane.setAttribute("opacity", 0);
  });

  // AUTO-SCALE
  AFRAME.registerComponent("autoscale", {
    tick: function () {
      if (!marker.object3D.visible) return;

      const markerPos = new THREE.Vector3();
      const camPos = new THREE.Vector3();

      marker.object3D.getWorldPosition(markerPos);
      camera.object3D.getWorldPosition(camPos);

      const distance = markerPos.distanceTo(camPos);

      let scale = 10 / distance;

      const maxScale = 3;
      const minScale = 0.5;

      scale = Math.min(maxScale, Math.max(minScale, scale));

      container.setAttribute("scale", `${scale} ${scale} ${scale}`);
    }
  });

  container.setAttribute("autoscale", "");
</script>

</body>
</html>